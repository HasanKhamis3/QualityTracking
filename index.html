<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة جودة التعليم والتعلم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* جميع الأنماط السابقة تبقى كما هي */
        /* ... */
        
        /* إضافة أنماط جديدة لتحسين واجهة التفعيل */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-label {
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .toggle-active {
            color: var(--success);
        }
        
        .toggle-inactive {
            color: var(--danger);
        }
        
        /* تحسينات لواجهة رفع الملفات */
        .upload-area {
            position: relative;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
            background-color: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(44, 90, 160, 0.05);
        }
        
        .upload-area.active {
            border-color: var(--primary);
            background-color: rgba(44, 90, 160, 0.05);
        }
        
        .upload-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .upload-file-name {
            margin-top: 10px;
            font-size: 0.875rem;
            color: var(--gray);
        }
        
        .upload-success {
            color: var(--success);
        }
        
        .upload-error {
            color: var(--danger);
        }
        
        /* تحسينات لواجهة قسم المستخدمين */
        .user-category-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
        }
        
        .user-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .user-category-title {
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: 700;
        }
        
        .user-category-actions {
            display: flex;
            gap: 10px;
        }
        
        /* تحسينات للجدول */
        .users-table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .users-table th, .users-table td {
            padding: 12px 15px;
            text-align: right;
            border: 1px solid #ddd;
        }
        
        .users-table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }
        
        .users-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .users-table tr:hover {
            background-color: #e9ecef;
        }
        
        /* تحسينات للزر التفعيل */
        .toggle-btn {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-btn input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        .toggle-slider:after {
            content: "إيقاف";
            color: white;
            position: absolute;
            left: 8px;
            top: 6px;
            font-size: 10px;
            font-weight: bold;
        }
        
        input:checked + .toggle-slider:after {
            content: "تفعيل";
            left: 8px;
        }
    </style>
</head>
<body>
    <!-- الكود السابق يبقى كما هو -->
    <!-- ... -->
    
    <!-- قسم إدارة المستخدمين المحدث -->
    <section id="users" class="section">
        <div class="section-header">
            <h2 class="section-title">إدارة المستخدمين</h2>
            <div class="btn-group">
                <button class="btn" id="addUserBtn">إضافة مستخدم</button>
            </div>
        </div>
        
        <!-- قسم القيادة العليا -->
        <div class="user-category-section" id="seniorLeadershipSection">
            <div class="user-category-header">
                <h3 class="user-category-title">القيادة العليا</h3>
                <div class="user-category-actions">
                    <button class="btn btn-sm" id="downloadSeniorLeadership">تنزيل ملف Excel</button>
                    <button class="btn btn-sm" id="seniorLeadershipUploadBtn">رفع ملف Excel</button>
                    <input type="file" id="seniorLeadershipFile" accept=".xlsx, .xls" style="display: none;">
                </div>
            </div>
            <div class="upload-area" id="seniorLeadershipUpload">
                <i class="fas fa-file-excel upload-icon"></i>
                <p>اسحب وأفلت ملف Excel هنا أو انقر للاختيار</p>
                <p class="upload-file-name" id="seniorLeadershipFileName"></p>
            </div>
            <div class="users-table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الوظيفة</th>
                            <th>اسم المستخدم</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="seniorLeadershipUsersTable">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- قسم القيادة الوسطى -->
        <div class="user-category-section" id="middleLeadershipSection">
            <div class="user-category-header">
                <h3 class="user-category-title">القيادة الوسطى</h3>
                <div class="user-category-actions">
                    <button class="btn btn-sm" id="downloadMiddleLeadership">تنزيل ملف Excel</button>
                    <button class="btn btn-sm" id="middleLeadershipUploadBtn">رفع ملف Excel</button>
                    <input type="file" id="middleLeadershipFile" accept=".xlsx, .xls" style="display: none;">
                </div>
            </div>
            <div class="upload-area" id="middleLeadershipUpload">
                <i class="fas fa-file-excel upload-icon"></i>
                <p>اسحب وأفلت ملف Excel هنا أو انقر للاختيار</p>
                <p class="upload-file-name" id="middleLeadershipFileName"></p>
            </div>
            <div class="users-table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الوظيفة</th>
                            <th>اسم المستخدم</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="middleLeadershipUsersTable">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- قسم المعلمات -->
        <div class="user-category-section" id="teachersSection">
            <div class="user-category-header">
                <h3 class="user-category-title">المعلمات</h3>
                <div class="user-category-actions">
                    <button class="btn btn-sm" id="downloadTeachers">تنزيل ملف Excel</button>
                    <button class="btn btn-sm" id="teachersUploadBtn">رفع ملف Excel</button>
                    <input type="file" id="teachersFile" accept=".xlsx, .xls" style="display: none;">
                </div>
            </div>
            <div class="upload-area" id="teachersUpload">
                <i class="fas fa-file-excel upload-icon"></i>
                <p>اسحب وأفلت ملف Excel هنا أو انقر للاختيار</p>
                <p class="upload-file-name" id="teachersFileName"></p>
            </div>
            <div class="users-table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الوظيفة</th>
                            <th>اسم المستخدم</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="teachersUsersTable">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- باقي الكود يبقى كما هو -->
    <!-- ... -->

    <script>
        // بيانات التطبيق
        const appData = {
            currentUser: null,
            users: [
                { 
                    id: 1, 
                    username: 'admin', 
                    password: 'admin123', 
                    name: 'مدير النظام', 
                    position: 'مدير النظام',
                    role: 'admin', 
                    avatar: 'م',
                    active: true,
                    permissions: {
                        dashboard: true,
                        middleLeadership: true,
                        visits: true,
                        performance: true,
                        teachers: true,
                        reports: true,
                        users: true,
                        departments: {
                            'القيادة العليا': true,
                            'القيادة الوسطى': true
                        }
                    }
                }
            ],
            middleLeadership: [],
            visits: [],
            performance: [],
            distinguishedTeachers: [],
            teachersNeedCare: [],
            reports: []
        };

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // محاولة استعادة حالة تسجيل الدخول من localStorage
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                const user = appData.users.find(u => u.id === userData.id);
                if (user) {
                    appData.currentUser = user;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userAvatar').textContent = user.avatar;
                    
                    // إظهار أو إخفاء تبويب إدارة المستخدمين بناءً على الصلاحية
                    if (user.role === 'admin') {
                        document.getElementById('usersTab').style.display = 'block';
                    }
                    
                    renderData();
                    
                    // التنقل إلى القسم المحفوظ
                    const savedSection = localStorage.getItem('currentSection') || 'dashboard';
                    navigateToSection(savedSection);
                }
            }
            
            // تحميل البيانات من localStorage إذا كانت موجودة
            loadDataFromStorage();
            
            // إعداد معالج تسجيل الدخول
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // إعداد معالج تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // إعداد التنقل بين الأقسام
            setupNavigation();
            
            // إعداد الأزرار والإجراءات
            setupButtons();
            
            // إعداد الروابط حسب الهاش
            setupHashRouting();
        });

        // تحميل البيانات من localStorage
        function loadDataFromStorage() {
            const savedData = localStorage.getItem('educationQualityData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                // دمج البيانات مع الحفاظ على المستخدم الحالي
                const currentUser = appData.currentUser;
                Object.assign(appData, parsedData);
                if (currentUser) {
                    appData.currentUser = currentUser;
                }
            }
        }

        // حفظ البيانات إلى localStorage
        function saveDataToStorage() {
            localStorage.setItem('educationQualityData', JSON.stringify(appData));
        }

        // إعداد التوجيه حسب الهاش
        function setupHashRouting() {
            // تحديث الرابط عند تغيير القسم
            window.addEventListener('hashchange', function() {
                const hash = window.location.hash.substring(1) || 'dashboard';
                navigateToSection(hash);
            });
            
            // التعامل مع الرابط الأولي عند التحميل
            const initialHash = window.location.hash.substring(1) || 'dashboard';
            navigateToSection(initialHash);
        }

        // التنقل إلى قسم معين
        function navigateToSection(sectionId) {
            // حفظ القسم الحالي
            localStorage.setItem('currentSection', sectionId);
            
            // تحديث الروابط
            document.querySelectorAll('.nav-tabs a').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-section') === sectionId) {
                    tab.classList.add('active');
                }
            });
            
            // إظهار القسم المطلوب
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                if (section.id === sectionId) {
                    section.classList.add('active');
                }
            });
            
            // تحديث الهاش في الرابط
            window.location.hash = sectionId;
            
            // إذا كان قسم المستخدمين، عرض قائمة المستخدمين
            if (sectionId === 'users') {
                renderUserList();
            }
            
            // إذا كان قسم تقييم الأداء، عرض الرسم البياني
            if (sectionId === 'performance') {
                renderPerformanceChart();
            }
        }

        // معالج تسجيل الدخول
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = appData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                if (!user.active) {
                    alert('هذا المستخدم غير مفعل. يرجى التواصل مع الإدارة.');
                    return;
                }
                
                appData.currentUser = user;
                // حفظ حالة تسجيل الدخول
                localStorage.setItem('currentUser', JSON.stringify({ id: user.id }));
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userAvatar').textContent = user.avatar;
                
                // إظهار أو إخفاء تبويب إدارة المستخدمين بناءً على الصلاحية
                if (user.role === 'admin') {
                    document.getElementById('usersTab').style.display = 'block';
                }
                
                renderData();
                
                // التنقل إلى القسم الافتراضي
                navigateToSection('dashboard');
            } else {
                alert('اسم المستخدم أو كلمة المرور غير صحيحة');
            }
        }

        // معالج تسجيل الخروج
        function handleLogout() {
            appData.currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        // إعداد التنقل بين الأقسام
        function setupNavigation() {
            const navTabs = document.querySelectorAll('.nav-tabs a');
            
            navTabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    navigateToSection(sectionId);
                });
            });
        }

        // إعداد الأزرار والإجراءات
        function setupButtons() {
            // أزرار القيادة الوسطى
            document.getElementById('saveMiddleLeadership').addEventListener('click', saveMiddleLeadership);
            
            // أزرار الزيارات
            document.getElementById('addVisitBtn').addEventListener('click', showAddVisitModal);
            document.getElementById('cancelVisit').addEventListener('click', closeVisitModal);
            document.querySelector('#visitModal .close-modal').addEventListener('click', closeVisitModal);
            document.getElementById('visitForm').addEventListener('submit', saveVisit);
            
            // أزرار الأقسام الفرعية للزيارات
            document.querySelectorAll('#visitsSubSections .sub-section-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#visitsSubSections .sub-section-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const department = this.getAttribute('data-department');
                    renderVisitsByDepartment(department);
                });
            });
            
            // أزرار التقييم
            document.getElementById('savePerformance').addEventListener('click', savePerformance);
            document.getElementById('performanceMonth').addEventListener('change', renderPerformanceChart);
            
            // أزرار المعلمين
            document.getElementById('saveTeachers').addEventListener('click', saveTeachers);
            
            // أزرار التقارير
            document.getElementById('saveReports').addEventListener('click', saveReports);
            
            // أزرار إدارة المستخدمين
            document.getElementById('addUserBtn').addEventListener('click', showAddUserModal);
            document.getElementById('cancelUser').addEventListener('click', closeUserModal);
            document.querySelector('#userModal .close-modal').addEventListener('click', closeUserModal);
            document.getElementById('userForm').addEventListener('submit', saveUser);
            
            // أزرار رفع ملفات Excel
            document.getElementById('seniorLeadershipUploadBtn').addEventListener('click', function() {
                document.getElementById('seniorLeadershipFile').click();
            });
            
            document.getElementById('middleLeadershipUploadBtn').addEventListener('click', function() {
                document.getElementById('middleLeadershipFile').click();
            });
            
            document.getElementById('teachersUploadBtn').addEventListener('click', function() {
                document.getElementById('teachersFile').click();
            });
            
            // إعداد مناطق السحب والإفلات
            setupDragAndDrop('seniorLeadershipUpload', 'seniorLeadershipFile');
            setupDragAndDrop('middleLeadershipUpload', 'middleLeadershipFile');
            setupDragAndDrop('teachersUpload', 'teachersFile');
            
            // أزرار تنزيل ملفات Excel
            document.getElementById('downloadSeniorLeadership').addEventListener('click', function() {
                downloadExcel('senior_leadership');
            });
            
            document.getElementById('downloadMiddleLeadership').addEventListener('click', function() {
                downloadExcel('middle_leadership');
            });
            
            document.getElementById('downloadTeachers').addEventListener('click', function() {
                downloadExcel('teacher');
            });
            
            // معالجة اختيار الملفات
            document.getElementById('seniorLeadershipFile').addEventListener('change', handleExcelUpload);
            document.getElementById('middleLeadershipFile').addEventListener('change', handleExcelUpload);
            document.getElementById('teachersFile').addEventListener('change', handleExcelUpload);
            
            // أزرار النماذج الإضافية
            document.getElementById('savePermissions').addEventListener('click', savePermissions);
            document.getElementById('cancelPermissions').addEventListener('click', closePermissionsModal);
            document.querySelector('#permissionsModal .close-modal').addEventListener('click', closePermissionsModal);
            
            document.getElementById('closePreview').addEventListener('click', closePreviewModal);
            document.querySelector('#previewModal .close-modal').addEventListener('click', closePreviewModal);
        }

        // إعداد السحب والإفلات
        function setupDragAndDrop(uploadAreaId, fileInputId) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(fileInputId);
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('active');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('active');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('active');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect(e.dataTransfer.files[0], fileInputId);
                }
            });
            
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
        }

        // معالجة اختيار الملف
        function handleFileSelect(file, fileInputId) {
            const fileNameElement = document.getElementById(fileInputId.replace('File', 'FileName'));
            fileNameElement.textContent = file.name;
            fileNameElement.className = 'upload-file-name';
        }

        // معالجة رفع ملفات Excel
        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const fileType = e.target.id;
            let userRole = '';
            
            if (fileType === 'seniorLeadershipFile') {
                userRole = 'senior_leadership';
            } else if (fileType === 'middleLeadershipFile') {
                userRole = 'middle_leadership';
            } else if (fileType === 'teachersFile') {
                userRole = 'teacher';
            }
            
            // عرض اسم الملف
            const fileNameElement = document.getElementById(fileType.replace('File', 'FileName'));
            fileNameElement.textContent = file.name;
            fileNameElement.className = 'upload-file-name';
            
            // قراءة ملف Excel
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // افتراض أن الورقة الأولى تحتوي على البيانات
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // معالجة البيانات وإضافة المستخدمين
                    processExcelData(jsonData, userRole);
                    
                    fileNameElement.className = 'upload-file-name upload-success';
                    fileNameElement.innerHTML = `<i class="fas fa-check-circle"></i> ${file.name} - تم الرفع بنجاح`;
                    
                    // إعادة تعيين حقل الملف
                    e.target.value = '';
                    
                    // إعادة عرض قائمة المستخدمين
                    renderUserList();
                    
                    alert(`تم رفع ملف ${file.name} بنجاح وإضافة ${jsonData.length} مستخدم جديد`);
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    fileNameElement.className = 'upload-file-name upload-error';
                    fileNameElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${file.name} - خطأ في معالجة الملف`;
                    alert('حدث خطأ أثناء معالجة الملف. يرجى التأكد من صيغة الملف والمحتويات.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // معالجة بيانات Excel وإضافة المستخدمين
        function processExcelData(data, role) {
            data.forEach((row, index) => {
                // البحث عن المستخدم إذا كان موجوداً
                const existingUser = appData.users.find(u => 
                    u.name === row['الاسم'] && u.role === role
                );
                
                if (!existingUser) {
                    // إنشاء مستخدم جديد
                    const username = generateUsername(row['الاسم'], role);
                    const password = generatePassword();
                    
                    // إنشاء صلاحيات افتراضية بناءً على الدور
                    const defaultPermissions = {
                        dashboard: true,
                        middleLeadership: role === 'admin' || role === 'supervisor',
                        visits: true,
                        performance: role === 'admin' || role === 'supervisor',
                        teachers: role === 'admin' || role === 'supervisor',
                        reports: role === 'admin' || role === 'supervisor',
                        users: role === 'admin',
                        departments: {
                            'القيادة العليا': role === 'admin' || role === 'senior_leadership',
                            'القيادة الوسطى': role === 'admin' || role === 'middle_leadership'
                        }
                    };
                    
                    const newUser = {
                        id: Math.max(...appData.users.map(u => u.id), 0) + 1,
                        name: row['الاسم'],
                        position: row['الوظيفة'] || getDefaultPosition(role),
                        username,
                        password,
                        role,
                        avatar: row['الاسم'].charAt(0),
                        active: true,
                        permissions: defaultPermissions
                    };
                    
                    appData.users.push(newUser);
                }
            });
            
            saveDataToStorage();
        }

        // إنشاء اسم مستخدم تلقائي
        function generateUsername(name, role) {
            const baseUsername = name.replace(/\s+/g, '').toLowerCase();
            let username = baseUsername;
            let counter = 1;
            
            // التحقق من عدم تكرار اسم المستخدم
            while (appData.users.some(u => u.username === username)) {
                username = `${baseUsername}${counter}`;
                counter++;
            }
            
            return username;
        }

        // إنشاء كلمة مرور عشوائية
        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // الحصول على الوظيفة الافتراضية بناءً على الدور
        function getDefaultPosition(role) {
            const positions = {
                'senior_leadership': 'عضو القيادة العليا',
                'middle_leadership': 'عضو القيادة الوسطى',
                'teacher': 'معلم'
            };
            return positions[role] || 'مستخدم';
        }

        // تنزيل ملف Excel
        function downloadExcel(role) {
            // تصفية المستخدمين حسب الدور
            const users = appData.users.filter(u => u.role === role);
            
            if (users.length === 0) {
                alert('لا توجد بيانات للتنزيل');
                return;
            }
            
            // تحضير البيانات للتصدير
            const data = users.map(user => ({
                'الاسم': user.name,
                'الوظيفة': user.position,
                'اسم المستخدم': user.username,
                'الحالة': user.active ? 'مفعل' : 'غير مفعل'
            }));
            
            // إنشاء ورقة عمل
            const worksheet = XLSX.utils.json_to_sheet(data);
            
            // إنشاء مصنف وإضافة الورقة
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'المستخدمين');
            
            // تحديد اسم الملف بناءً على الدور
            let fileName = '';
            if (role === 'senior_leadership') {
                fileName = 'قائمة_القيادة_العليا.xlsx';
            } else if (role === 'middle_leadership') {
                fileName = 'قائمة_القيادة_الوسطى.xlsx';
            } else if (role === 'teacher') {
                fileName = 'قائمة_المعلمات.xlsx';
            }
            
            // تنزيل الملف
            XLSX.writeFile(workbook, fileName);
            alert(`تم تنزيل الملف ${fileName} بنجاح`);
        }

        // عرض قائمة المستخدمين
        function renderUserList() {
            renderUserCategory('senior_leadership', 'seniorLeadershipUsersTable');
            renderUserCategory('middle_leadership', 'middleLeadershipUsersTable');
            renderUserCategory('teacher', 'teachersUsersTable');
        }

        // عرض فئة المستخدمين
        function renderUserCategory(role, tableId) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';
            
            const users = appData.users.filter(user => user.role === role);
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.position}</td>
                    <td>${user.username}</td>
                    <td>
                        <div class="toggle-container">
                            <label class="toggle-btn">
                                <input type="checkbox" ${user.active ? 'checked' : ''} data-id="${user.id}">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label ${user.active ? 'toggle-active' : 'toggle-inactive'}">
                                ${user.active ? 'مفعل' : 'غير مفعل'}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="user-actions">
                            <button class="btn btn-xs btn-secondary edit-user" data-id="${user.id}">تعديل</button>
                            <button class="btn btn-xs btn-warning permissions-user" data-id="${user.id}">صلاحيات</button>
                            <button class="btn btn-xs btn-success preview-user" data-id="${user.id}">معاينة</button>
                            ${user.id !== appData.currentUser.id && user.id !== 1 ? `
                                <button class="btn btn-xs btn-danger delete-user" data-id="${user.id}">حذف</button>
                            ` : ''}
                        </div>
                    </td>
                `;
                table.appendChild(row);
            });
            
            // إضافة معالجي الأحداث للأزرار
            document.querySelectorAll(`#${tableId} .edit-user`).forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    editUser(userId);
                });
            });
            
            document.querySelectorAll(`#${tableId} .permissions-user`).forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    showPermissionsModal(userId);
                });
            });
            
            document.querySelectorAll(`#${tableId} .preview-user`).forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    showPreviewModal(userId);
                });
            });
            
            document.querySelectorAll(`#${tableId} .delete-user`).forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    deleteUser(userId);
                });
            });
            
            // إضافة معالجي الأحداث لأزرار التفعيل
            document.querySelectorAll(`#${tableId} input[type="checkbox"]`).forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    toggleUser(userId, this.checked);
                });
            });
        }

        // تفعيل/إلغاء تفعيل مستخدم
        function toggleUser(userId, active) {
            const user = appData.users.find(u => u.id === userId);
            if (!user) return;
            
            // منع إلغاء تفعيل الحساب الرئيسي
            if (user.id === 1 && !active) {
                alert('لا يمكن إلغاء تفعيل الحساب الرئيسي');
                document.querySelector(`input[data-id="${userId}"]`).checked = true;
                return;
            }
            
            user.active = active;
            saveDataToStorage();
            
            // تحديث التسمية
            const label = document.querySelector(`input[data-id="${userId}"]`).closest('.toggle-container').querySelector('.toggle-label');
            label.textContent = active ? 'مفعل' : 'غير مفعل';
            label.className = `toggle-label ${active ? 'toggle-active' : 'toggle-inactive'}`;
            
            alert(`تم ${active ? 'تفعيل' : 'إلغاء تفعيل'} المستخدم بنجاح`);
        }

        // باقي الدوال تبقى كما هي مع تعديلات بسيطة
        // ... (جميع الدوال الأخرى تبقى كما هي)

        // تعديل مستخدم
        function editUser(userId) {
            const user = appData.users.find(u => u.id === userId);
            if (!user) return;
            
            // منع تعديل الحساب الرئيسي من قبل مستخدمين آخرين
            if (user.id === 1 && appData.currentUser.id !== 1) {
                alert('لا يمكن تعديل الحساب الرئيسي');
                return;
            }
            
            document.getElementById('userModalTitle').textContent = 'تعديل بيانات المستخدم';
            document.getElementById('userId').value = user.id;
            document.getElementById('userFullName').value = user.name;
            document.getElementById('userPosition').value = user.position;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userPassword').value = '';
            
            // منع تغيير دور الحساب الرئيسي
            if (user.id === 1) {
                document.getElementById('userRole').disabled = true;
            } else {
                document.getElementById('userRole').disabled = false;
            }
            
            document.getElementById('userModal').style.display = 'flex';
        }

        // حذف مستخدم
        function deleteUser(userId) {
            const user = appData.users.find(u => u.id === userId);
            if (!user) return;
            
            // منع حذف الحساب الرئيسي
            if (user.id === 1) {
                alert('لا يمكن حذف الحساب الرئيسي');
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                appData.users = appData.users.filter(u => u.id !== userId);
                saveDataToStorage();
                renderUserList();
                alert('تم حذف المستخدم بنجاح');
            }
        }

        // باقي الدوال تبقى كما هي
        // ... (جميع الدوال الأخرى تبقى كما هي)
    </script>
</body>
</html>
