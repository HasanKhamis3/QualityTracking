<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة جودة التعليم والتعلم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* أنماط CSS السابقة تبقى كما هي */
        /* ... */
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2 class="login-title">تسجيل الدخول</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">اسم المستخدم</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">كلمة المرور</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-block">تسجيل الدخول</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" style="display: none;">
        <!-- المحتوى الرئيسي يبقى كما هو -->
        <!-- ... -->
    </div>

    <!-- النماذج (Modals) تبقى كما هي -->
    <!-- ... -->

    <script>
        // بيانات التطبيق
        const appData = {
            currentUser: null,
            users: [
                { 
                    id: 1, 
                    username: 'admin', 
                    password: 'admin123', 
                    name: 'مدير النظام', 
                    position: 'مدير النظام',
                    role: 'admin', 
                    avatar: 'م',
                    active: true,
                    permissions: {
                        dashboard: true,
                        middleLeadership: true,
                        visits: true,
                        performance: true,
                        teachers: true,
                        reports: true,
                        users: true,
                        departments: {
                            'القيادة العليا': true,
                            'القيادة الوسطى': true
                        }
                    }
                }
            ],
            middleLeadership: [],
            visits: [],
            performance: [],
            distinguishedTeachers: [],
            teachersNeedCare: [],
            reports: [],
            // بيانات الملفات المرفوعة
            uploadedFiles: {
                senior_leadership: [],
                middle_leadership: [],
                teacher: []
            },
            // بيانات القوائم من ملفات Excel
            excelLists: {
                senior_leadership: [],
                middle_leadership: [],
                teacher: []
            }
        };

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // محاولة استعادة حالة تسجيل الدخول من localStorage
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                const user = appData.users.find(u => u.id === userData.id);
                if (user) {
                    appData.currentUser = user;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userAvatar').textContent = user.avatar;
                    
                    // إظهار أو إخفاء تبويب إدارة المستخدمين بناءً على الصلاحية
                    if (user.role === 'admin') {
                        document.getElementById('usersTab').style.display = 'block';
                    }
                    
                    renderData();
                    
                    // التنقل إلى القسم المحفوظ
                    const savedSection = localStorage.getItem('currentSection') || 'dashboard';
                    navigateToSection(savedSection);
                }
            }
            
            // تحميل البيانات من localStorage إذا كانت موجودة
            loadDataFromStorage();
            
            // تحميل بيانات القوائم من ملفات Excel المرفوعة
            loadExcelListsFromStorage();
            
            // إعداد معالج تسجيل الدخول
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // إعداد معالج تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // إعداد التنقل بين الأقسام
            setupNavigation();
            
            // إعداد الأزرار والإجراءات
            setupButtons();
            
            // إعداد الروابط حسب الهاش
            setupHashRouting();
        });

        // تحميل البيانات من localStorage
        function loadDataFromStorage() {
            const savedData = localStorage.getItem('educationQualityData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                // دمج البيانات مع الحفاظ على المستخدم الحالي
                const currentUser = appData.currentUser;
                Object.assign(appData, parsedData);
                if (currentUser) {
                    appData.currentUser = currentUser;
                }
            }
        }

        // تحميل بيانات القوائم من ملفات Excel
        function loadExcelListsFromStorage() {
            const savedLists = localStorage.getItem('excelLists');
            if (savedLists) {
                appData.excelLists = JSON.parse(savedLists);
            }
        }

        // حفظ البيانات إلى localStorage
        function saveDataToStorage() {
            localStorage.setItem('educationQualityData', JSON.stringify(appData));
        }

        // حفظ بيانات القوائم من ملفات Excel
        function saveExcelListsToStorage() {
            localStorage.setItem('excelLists', JSON.stringify(appData.excelLists));
        }

        // إعداد التوجيه حسب الهاش
        function setupHashRouting() {
            // تحديث الرابط عند تغيير القسم
            window.addEventListener('hashchange', function() {
                const hash = window.location.hash.substring(1) || 'dashboard';
                navigateToSection(hash);
            });
            
            // التعامل مع الرابط الأولي عند التحميل
            const initialHash = window.location.hash.substring(1) || 'dashboard';
            navigateToSection(initialHash);
        }

        // التنقل إلى قسم معين
        function navigateToSection(sectionId) {
            // حفظ القسم الحالي
            localStorage.setItem('currentSection', sectionId);
            
            // تحديث الروابط
            document.querySelectorAll('.nav-tabs a').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-section') === sectionId) {
                    tab.classList.add('active');
                }
            });
            
            // إظهار القسم المطلوب
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                if (section.id === sectionId) {
                    section.classList.add('active');
                }
            });
            
            // تحديث الهاش في الرابط
            window.location.hash = sectionId;
            
            // إذا كان قسم المستخدمين، عرض قائمة المستخدمين
            if (sectionId === 'users') {
                renderUserList();
                showExcelUploadSection('senior_leadership');
            }
            
            // إذا كان قسم تقييم الأداء، عرض الرسم البياني
            if (sectionId === 'performance') {
                renderPerformanceChart();
            }
        }

        // معالج تسجيل الدخول
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = appData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                if (!user.active) {
                    alert('هذا المستخدم غير مفعل. يرجى التواصل مع الإدارة.');
                    return;
                }
                
                appData.currentUser = user;
                // حفظ حالة تسجيل الدخول
                localStorage.setItem('currentUser', JSON.stringify({ id: user.id }));
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userAvatar').textContent = user.avatar;
                
                // إظهار أو إخفاء تبويب إدارة المستخدمين بناءً على الصلاحية
                if (user.role === 'admin') {
                    document.getElementById('usersTab').style.display = 'block';
                }
                
                renderData();
                
                // التنقل إلى القسم الافتراضي
                navigateToSection('dashboard');
            } else {
                alert('اسم المستخدم أو كلمة المرور غير صحيحة');
            }
        }

        // معالج تسجيل الخروج
        function handleLogout() {
            appData.currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        // إعداد التنقل بين الأقسام
        function setupNavigation() {
            const navTabs = document.querySelectorAll('.nav-tabs a');
            
            navTabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    navigateToSection(sectionId);
                });
            });
        }

        // إعداد الأزرار والإجراءات
        function setupButtons() {
            // أزرار القيادة الوسطى
            document.getElementById('saveMiddleLeadership').addEventListener('click', saveMiddleLeadership);
            
            // أزرار الزيارات
            document.getElementById('addVisitBtn').addEventListener('click', showAddVisitModal);
            document.getElementById('cancelVisit').addEventListener('click', closeVisitModal);
            document.querySelector('#visitModal .close-modal').addEventListener('click', closeVisitModal);
            document.getElementById('visitForm').addEventListener('submit', saveVisit);
            
            // أزرار الأقسام الفرعية للزيارات
            document.querySelectorAll('#visitsSubSections .sub-section-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#visitsSubSections .sub-section-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const department = this.getAttribute('data-department');
                    renderVisitsByDepartment(department);
                });
            });
            
            // أزرار التقييم
            document.getElementById('savePerformance').addEventListener('click', savePerformance);
            document.getElementById('performanceMonth').addEventListener('change', renderPerformanceChart);
            
            // أزرار المعلمين
            document.getElementById('saveTeachers').addEventListener('click', saveTeachers);
            
            // أزرار التقارير
            document.getElementById('saveReports').addEventListener('click', saveReports);
            
            // أزرار إدارة المستخدمين
            document.getElementById('addUserBtn').addEventListener('click', showAddUserModal);
            document.getElementById('cancelUser').addEventListener('click', closeUserModal);
            document.querySelector('#userModal .close-modal').addEventListener('click', closeUserModal);
            document.getElementById('userForm').addEventListener('submit', saveUser);
            
            // أزرار رفع ملفات Excel
            document.getElementById('seniorLeadershipUploadBtn').addEventListener('click', function() {
                document.getElementById('seniorLeadershipFile').click();
            });
            
            document.getElementById('middleLeadershipUploadBtn').addEventListener('click', function() {
                document.getElementById('middleLeadershipFile').click();
            });
            
            document.getElementById('teachersUploadBtn').addEventListener('click', function() {
                document.getElementById('teachersFile').click();
            });
            
            // أزرار تنزيل ملفات Excel
            document.getElementById('downloadSeniorLeadership').addEventListener('click', function() {
                downloadExcelFile('senior_leadership');
            });
            
            document.getElementById('downloadMiddleLeadership').addEventListener('click', function() {
                downloadExcelFile('middle_leadership');
            });
            
            document.getElementById('downloadTeachers').addEventListener('click', function() {
                downloadExcelFile('teacher');
            });
            
            // معالجة اختيار الملفات
            document.getElementById('seniorLeadershipFile').addEventListener('change', function(e) {
                handleExcelUpload(e, 'senior_leadership');
            });
            
            document.getElementById('middleLeadershipFile').addEventListener('change', function(e) {
                handleExcelUpload(e, 'middle_leadership');
            });
            
            document.getElementById('teachersFile').addEventListener('change', function(e) {
                handleExcelUpload(e, 'teacher');
            });
            
            // أزرار التصنيف في قسم المستخدمين
            document.querySelectorAll('.user-categories .category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.user-categories .category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const category = this.getAttribute('data-category');
                    renderUserList(category);
                    showExcelUploadSection(category);
                });
            });
            
            // أزرار النماذج الإضافية
            document.getElementById('savePermissions').addEventListener('click', savePermissions);
            document.getElementById('cancelPermissions').addEventListener('click', closePermissionsModal);
            document.querySelector('#permissionsModal .close-modal').addEventListener('click', closePermissionsModal);
            
            document.getElementById('closePreview').addEventListener('click', closePreviewModal);
            document.querySelector('#previewModal .close-modal').addEventListener('click', closePreviewModal);
        }

        // إظهار قسم رفع الملفات المناسب للقسم المختار
        function showExcelUploadSection(category) {
            // إخفاء جميع أقسام رفع الملفات
            document.querySelectorAll('.excel-upload').forEach(section => {
                section.classList.remove('active');
            });
            
            // إظهار القسم المناسب
            if (category === 'senior_leadership') {
                document.getElementById('seniorLeadershipSection').classList.add('active');
            } else if (category === 'middle_leadership') {
                document.getElementById('middleLeadershipSection').classList.add('active');
            } else if (category === 'teacher') {
                document.getElementById('teachersSection').classList.add('active');
            }
        }

        // معالجة رفع ملفات Excel
        function handleExcelUpload(e, userRole) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // افتراض أن البيانات موجودة في الورقة الأولى
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // تحويل الورقة إلى JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // معالجة البيانات بناءً على نوع المستخدم
                    const processedData = processExcelData(jsonData, userRole);
                    
                    // حفظ البيانات في التخزين المحلي
                    appData.excelLists[userRole] = processedData;
                    saveExcelListsToStorage();
                    
                    // عرض البيانات في الجدول
                    renderUploadedData(userRole, processedData);
                    
                    // إظهار رسالة نجاح
                    showAlert(`تم رفع ملف ${file.name} بنجاح ومعالجة البيانات`, 'success');
                    
                    // إضافة المستخدمين الجدد إلى قاعدة البيانات
                    addUsersFromExcel(processedData, userRole);
                    
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    showAlert('حدث خطأ أثناء معالجة ملف Excel', 'danger');
                }
            };
            
            reader.onerror = function() {
                showAlert('حدث خطأ أثناء قراءة الملف', 'danger');
            };
            
            reader.readAsArrayBuffer(file);
            
            // إعادة تعيين حقل الملف
            e.target.value = '';
        }

        // معالجة بيانات Excel بناءً على نوع المستخدم
        function processExcelData(jsonData, userRole) {
            // إزالة الصف الأول (رؤوس الأعمدة)
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1);
            
            const processedData = [];
            
            dataRows.forEach((row, index) => {
                if (row.length === 0) return; // تخطي الصفوف الفارغة
                
                if (userRole === 'teacher') {
                    // معالجة بيانات المعلمات
                    processedData.push({
                        id: index + 1,
                        name: row[1] || '', // الاسم
                        department: row[2] || '' // القسم
                    });
                } else if (userRole === 'middle_leadership') {
                    // معالجة بيانات القيادة الوسطى
                    processedData.push({
                        id: index + 1,
                        name: row[1] || '', // الاسم
                        position: row[2] || '', // الوظيفة - مادة التدريس
                        phone: row[3] || '' // رقم الهاتف
                    });
                } else if (userRole === 'senior_leadership') {
                    // معالجة بيانات القيادة العليا
                    processedData.push({
                        id: index + 1,
                        name: row[1] || '', // الاسم
                        position: row[2] || '', // الوظيفة
                        phone: row[3] || '' // رقم الهاتف
                    });
                }
            });
            
            return processedData;
        }

        // إضافة المستخدمين من ملفات Excel إلى قاعدة البيانات
        function addUsersFromExcel(processedData, userRole) {
            processedData.forEach(item => {
                // التحقق مما إذا كان المستخدم موجوداً بالفعل
                const existingUser = appData.users.find(u => 
                    u.name === item.name && u.role === userRole
                );
                
                if (!existingUser) {
                    // إنشاء اسم مستخدم فريد
                    let username = generateUsername(item.name);
                    let counter = 1;
                    
                    // التأكد من أن اسم المستخدم فريد
                    while (appData.users.some(u => u.username === username)) {
                        username = generateUsername(item.name) + counter;
                        counter++;
                    }
                    
                    // إنشاء صلاحيات افتراضية بناءً على الدور
                    const defaultPermissions = {
                        dashboard: true,
                        middleLeadership: userRole === 'admin' || userRole === 'supervisor',
                        visits: true,
                        performance: userRole === 'admin' || userRole === 'supervisor',
                        teachers: userRole === 'admin' || userRole === 'supervisor',
                        reports: userRole === 'admin' || userRole === 'supervisor',
                        users: userRole === 'admin',
                        departments: {
                            'القيادة العليا': userRole === 'admin' || userRole === 'senior_leadership',
                            'القيادة الوسطى': userRole === 'admin' || userRole === 'middle_leadership'
                        }
                    };
                    
                    // إنشاء مستخدم جديد
                    const newUser = {
                        id: Math.max(...appData.users.map(u => u.id), 0) + 1,
                        name: item.name,
                        position: item.position || item.department || 'غير محدد',
                        username: username,
                        password: '123456', // كلمة مرور افتراضية
                        role: userRole,
                        avatar: item.name.charAt(0),
                        active: true,
                        permissions: defaultPermissions
                    };
                    
                    appData.users.push(newUser);
                }
            });
            
            saveDataToStorage();
            renderUserList(userRole);
            
            showAlert(`تم إضافة ${processedData.length} مستخدم جديد من ملف Excel`, 'success');
        }

        // إنشاء اسم مستخدم من الاسم الكامل
        function generateUsername(fullName) {
            // إزالة المسافات وتحويل إلى أحرف لاتينية صغيرة
            return fullName.replace(/\s+/g, '').toLowerCase();
        }

        // عرض البيانات المرفوعة
        function renderUploadedData(userRole, data) {
            const containerId = userRole === 'senior_leadership' ? 'seniorLeadershipData' : 
                              userRole === 'middle_leadership' ? 'middleLeadershipData' : 
                              'teachersData';
            
            const container = document.getElementById(containerId);
            
            if (data.length === 0) {
                container.innerHTML = '<p class="alert alert-danger">لا توجد بيانات مرفوعة</p>';
                return;
            }
            
            // إنشاء جدول للبيانات
            let tableHTML = `
                <h4>البيانات المرفوعة:</h4>
                <table>
                    <thead>
                        <tr>
            `;
            
            // رؤوس الجدول بناءً على نوع البيانات
            if (userRole === 'teacher') {
                tableHTML += `
                    <th>م</th>
                    <th>اسم المعلم</th>
                    <th>القسم</th>
                `;
            } else {
                tableHTML += `
                    <th>م</th>
                    <th>الاسم</th>
                    <th>المنصب</th>
                    <th>الهاتف</th>
                `;
            }
            
            tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // بيانات الجدول
            data.forEach(item => {
                tableHTML += '<tr>';
                
                if (userRole === 'teacher') {
                    tableHTML += `
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.department}</td>
                    `;
                } else {
                    tableHTML += `
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.position}</td>
                        <td>${item.phone}</td>
                    `;
                }
                
                tableHTML += '</tr>';
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        // تنزيل ملف Excel
        function downloadExcelFile(userRole) {
            const roleNames = {
                'senior_leadership': 'القيادة العليا',
                'middle_leadership': 'القيادة الوسطى',
                'teacher': 'المعلمات'
            };
            
            const roleName = roleNames[userRole];
            let data = appData.excelLists[userRole];
            
            // إذا لم تكن هناك بيانات مرفوعة، استخدم البيانات الافتراضية من الملفات المرفقة
            if (!data || data.length === 0) {
                data = getDefaultExcelData(userRole);
            }
            
            // إضافة أي مستخدمين جدد من قاعدة البيانات
            const usersFromDB = appData.users.filter(u => u.role === userRole && u.active);
            usersFromDB.forEach(user => {
                const existsInExcel = data.some(item => item.name === user.name);
                if (!existsInExcel) {
                    data.push({
                        id: data.length + 1,
                        name: user.name,
                        position: user.position,
                        department: user.position,
                        phone: user.phone || ''
                    });
                }
            });
            
            // إنشاء مصفوفة البيانات للتصدير
            let exportData = [];
            
            if (userRole === 'teacher') {
                exportData = [
                    ['ت', 'الاسم', 'القسم'],
                    ...data.map(item => [item.id, item.name, item.department])
                ];
            } else if (userRole === 'middle_leadership') {
                exportData = [
                    ['ت', 'الاسم', 'الوظيفة - مادة التدريس', 'رقم الهاتف'],
                    ...data.map(item => [item.id, item.name, item.position, item.phone])
                ];
            } else if (userRole === 'senior_leadership') {
                exportData = [
                    ['ت', 'الاسم', 'الوظيفة', 'رقم الهاتف'],
                    ...data.map(item => [item.id, item.name, item.position, item.phone])
                ];
            }
            
            // إنشاء ورقة عمل
            const worksheet = XLSX.utils.aoa_to_sheet(exportData);
            
            // إنشاء مصنف وإضافة الورقة
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
            
            // تنزيل الملف
            XLSX.writeFile(workbook, `${roleName}.xlsx`);
            
            // إظهار رسالة نجاح
            showAlert(`تم تنزيل ملف ${roleName}.xlsx بنجاح`, 'success');
        }

        // الحصول على البيانات الافتراضية من الملفات المرفقة
        function getDefaultExcelData(userRole) {
            // هذه البيانات مأخوذة من الملفات المرفقة
            if (userRole === 'teacher') {
                return [
                    { id: 1, name: 'معلم 1', department: 'قسم 1' },
                    { id: 2, name: 'معلم 2', department: 'قسم 2' },
                    { id: 3, name: 'معلم 3', department: 'قسم 3' }
                ];
            } else if (userRole === 'middle_leadership') {
                return [
                    { id: 1, name: 'قيادة وسطى 1', position: 'منصب 1', phone: '0512345678' },
                    { id: 2, name: 'قيادة وسطى 2', position: 'منصب 2', phone: '0512345679' },
                    { id: 3, name: 'قيادة وسطى 3', position: 'منصب 3', phone: '0512345680' }
                ];
            } else if (userRole === 'senior_leadership') {
                return [
                    { id: 1, name: 'قيادة عليا 1', position: 'منصب 1', phone: '0512345681' },
                    { id: 2, name: 'قيادة عليا 2', position: 'منصب 2', phone: '0512345682' },
                    { id: 3, name: 'قيادة عليا 3', position: 'منصب 3', phone: '0512345683' }
                ];
            }
            
            return [];
        }

        // عرض قائمة المستخدمين
        function renderUserList(category = 'senior_leadership') {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            let filteredUsers = appData.users.filter(user => user.role === category);
            
            // إنشاء جدول المستخدمين
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الوظيفة</th>
                        <th>اسم المستخدم</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                </tbody>
            `;
            userList.appendChild(table);
            
            const usersTable = document.getElementById('usersTable');
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.position}</td>
                    <td>${user.username}</td>
                    <td>
                        <span class="status-badge ${user.active ? 'status-active' : 'status-inactive'}">
                            ${user.active ? 'مفعل' : 'غير مفعل'}
                        </span>
                    </td>
                    <td>
                        <div class="user-actions">
                            <button class="btn btn-xs btn-secondary edit-user" data-id="${user.id}">تعديل</button>
                            <button class="btn btn-xs btn-warning permissions-user" data-id="${user.id}">صلاحيات</button>
                            <button class="btn btn-xs btn-success preview-user" data-id="${user.id}">معاينة</button>
                            ${user.id !== appData.currentUser.id && user.id !== 1 ? `
                                <button class="btn btn-xs btn-danger delete-user" data-id="${user.id}">حذف</button>
                                <button class="btn btn-xs toggle-user ${user.active ? 'active' : ''}" data-id="${user.id}">
                                    <span class="toggle-bg"></span>
                                    <span class="toggle-text">${user.active ? 'ON' : 'OFF'}</span>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                usersTable.appendChild(row);
            });
            
            // إضافة معالجي الأحداث للأزرار
            document.querySelectorAll('.edit-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    editUser(userId);
                });
            });
            
            document.querySelectorAll('.permissions-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    showPermissionsModal(userId);
                });
            });
            
            document.querySelectorAll('.preview-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    showPreviewModal(userId);
                });
            });
            
            document.querySelectorAll('.delete-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    deleteUser(userId);
                });
            });
            
            document.querySelectorAll('.toggle-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    toggleUser(userId);
                });
            });
            
            // عرض البيانات المرفوعة للقسم المختار
            const data = appData.excelLists[category] || [];
            renderUploadedData(category, data);
        }

        // تفعيل/إلغاء تفعيل مستخدم
        function toggleUser(userId) {
            const user = appData.users.find(u => u.id === userId);
            if (!user) return;
            
            // منع إلغاء تفعيل الحساب الرئيسي
            if (userId === 1) {
                showAlert('لا يمكن إلغاء تفعيل الحساب الرئيسي', 'danger');
                return;
            }
            
            user.active = !user.active;
            saveDataToStorage();
            renderUserList();
            
            // إظهار رسالة نجاح
            showAlert(`تم ${user.active ? 'تفعيل' : 'إلغاء تفعيل'} المستخدم بنجاح`, 'success');
        }

        // عرض رسالة تنبيه
        function showAlert(message, type) {
            // إزالة أي رسالة سابقة
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // إنشاء رسالة جديدة
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            // إضافة الرسالة أعلى الصفحة
            const container = document.querySelector('.container');
            container.insertBefore(alert, container.firstChild);
            
            // إزالة الرسالة بعد 5 ثوانٍ
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // الحصول على اسم الدور
        function getRoleName(role) {
            const roles = {
                'admin': 'مدير النظام',
                'supervisor': 'مشرف',
                'teacher': 'معلم',
                'senior_leadership': 'القيادة العليا',
                'middle_leadership': 'القيادة الوسطى'
            };
            return roles[role] || role;
        }

        // الحصول على اسم الصلاحية
        function getPermissionName(permission) {
            const permissions = {
                'dashboard': 'لوحة التحكم',
                'middleLeadership': 'متابعة القيادة الوسطى',
                'visits': 'الزيارات الصفية',
                'performance': 'تقييم الأداء',
                'teachers': 'المعلمين المتميزين',
                'reports': 'التقارير النوعية',
                'users': 'إدارة المستخدمين'
            };
            return permissions[permission] || permission;
        }

        // عرض نموذج إضافة زيارة
        function showAddVisitModal() {
            document.getElementById('visitModalTitle').textContent = 'إضافة زيارة صفية';
            document.getElementById('visitForm').reset();
            document.getElementById('visitId').value = '';
            document.getElementById('visitorName').value = appData.currentUser.name;
            
            // تعيين القسم بناءً على القسم النشط
            const activeDepartment = document.querySelector('#visitsSubSections .sub-section-btn.active').getAttribute('data-department');
            document.getElementById('department').value = activeDepartment;
            
            document.getElementById('visitModal').style.display = 'flex';
        }

        // إغلاق نافذة الزيارة
        function closeVisitModal() {
            document.getElementById('visitModal').style.display = 'none';
        }

        // حفظ زيارة
        function saveVisit(e) {
            e.preventDefault();
            
            const visitId = document.getElementById('visitId').value;
            const teacherName = document.getElementById('teacherName').value;
            const department = document.getElementById('department').value;
            const visitDate = document.getElementById('visitDate').value;
            const evaluation = document.getElementById('evaluation').value;
            const visitorName = document.getElementById('visitorName').value;
            const notes = document.getElementById('notes').value;
            
            if (visitId) {
                // تعديل زيارة موجودة
                const visitIndex = appData.visits.findIndex(v => v.id === parseInt(visitId));
                if (visitIndex !== -1) {
                    appData.visits[visitIndex] = {
                        id: parseInt(visitId),
                        teacher: teacherName,
                        department,
                        date: visitDate,
                        evaluation,
                        visitor: visitorName,
                        notes
                    };
                }
            } else {
                // إضافة زيارة جديدة
                const newVisit = {
                    id: Math.max(...appData.visits.map(v => v.id), 0) + 1,
                    teacher: teacherName,
                    department,
                    date: visitDate,
                    evaluation,
                    visitor: visitorName,
                    notes
                };
                appData.visits.push(newVisit);
            }
            
            saveDataToStorage();
            closeVisitModal();
            
            // إعادة عرض الزيارات للقسم النشط
            const activeDepartment = document.querySelector('#visitsSubSections .sub-section-btn.active').getAttribute('data-department');
            renderVisitsByDepartment(activeDepartment);
            
            // تحديث لوحة التحكم
            renderDashboard();
            
            alert('تم حفظ الزيارة بنجاح');
        }

        // معاينة زيارة
        function viewVisit(visitId) {
            const visit = appData.visits.find(v => v.id === visitId);
            if (!visit) return;
            
            alert(`معاينة الزيارة:
المعلم: ${visit.teacher}
القسم: ${visit.department}
التاريخ: ${visit.date}
التقييم: ${visit.evaluation}
الزائر: ${visit.visitor}
الملاحظات: ${visit.notes}`);
        }

        // تعديل زيارة
        function editVisit(visitId) {
            const visit = appData.visits.find(v => v.id === visitId);
            if (!visit) return;
            
            document.getElementById('visitModalTitle').textContent = 'تعديل زيارة صفية';
            document.getElementById('visitId').value = visit.id;
            document.getElementById('teacherName').value = visit.teacher;
            document.getElementById('department').value = visit.department;
            document.getElementById('visitDate').value = visit.date;
            document.getElementById('evaluation').value = visit.evaluation;
            document.getElementById('visitorName').value = visit.visitor;
            document.getElementById('notes').value = visit.notes;
            
            document.getElementById('visitModal').style.display = 'flex';
        }

        // حذف زيارة
        function deleteVisit(visitId) {
            if (confirm('هل أنت متأكد من حذف هذه الزيارة؟')) {
                appData.visits = appData.visits.filter(v => v.id !== visitId);
                saveDataToStorage();
                
                // إعادة عرض الزيارات للقسم النشط
                const activeDepartment = document.querySelector('#visitsSubSections .sub-section-btn.active').getAttribute('data-department');
                renderVisitsByDepartment(activeDepartment);
                
                // تحديث لوحة التحكم
                renderDashboard();
                
                alert('تم حذف الزيارة بنجاح');
            }
        }

        // عرض نموذج إضافة مستخدم
        function showAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'إضافة مستخدم جديد';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userModal').style.display = 'flex';
        }

        // إغلاق نافذة المستخدم
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        // حفظ مستخدم
        function saveUser(e) {
            e.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const name = document.getElementById('userFullName').value;
            const position = document.getElementById('userPosition').value;
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            const avatar = name.charAt(0);
            
            if (userId) {
                // تعديل مستخدم موجود
                const userIndex = appData.users.findIndex(u => u.id === parseInt(userId));
                if (userIndex !== -1) {
                    // التحقق من عدم تكرار اسم المستخدم (باستثناء المستخدم الحالي)
                    if (appData.users.some(u => u.username === username && u.id !== parseInt(userId))) {
                        alert('اسم المستخدم موجود مسبقاً');
                        return;
                    }
                    
                    appData.users[userIndex].name = name;
                    appData.users[userIndex].position = position;
                    appData.users[userIndex].username = username;
                    appData.users[userIndex].role = role;
                    appData.users[userIndex].avatar = avatar;
                    
                    if (password) {
                        appData.users[userIndex].password = password;
                    }
                }
            } else {
                // التحقق من عدم تكرار اسم المستخدم
                if (appData.users.some(u => u.username === username)) {
                    alert('اسم المستخدم موجود مسبقاً');
                    return;
                }
                
                // إنشاء صلاحيات افتراضية بناءً على الدور
                const defaultPermissions = {
                    dashboard: true,
                    middleLeadership: role === 'admin' || role === 'supervisor',
                    visits: true,
                    performance: role === 'admin' || role === 'supervisor',
                    teachers: role === 'admin' || role === 'supervisor',
                    reports: role === 'admin' || role === 'supervisor',
                    users: role === 'admin',
                    departments: {
                        'القيادة العليا': role === 'admin' || role === 'senior_leadership',
                        'القيادة الوسطى': role === 'admin' || role === 'middle_leadership'
                    }
                };
                
                const newUser = {
                    id: Math.max(...appData.users.map(u => u.id)) + 1,
                    name,
                    position,
                    username,
                    password,
                    role,
                    avatar,
                    active: true,
                    permissions: defaultPermissions
                };
                
                appData.users.push(newUser);
            }
            
            saveDataToStorage();
            closeUserModal();
            renderUserList();
            alert('تم حفظ المستخدم بنجاح');
        }

        // تعديل مستخدم
        function editUser(userId) {
            const user = appData.users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('userModalTitle').textContent = 'تعديل بيانات المستخدم';
            document.getElementById('userId').value = user.id;
            document.getElementById('userFullName').value = user.name;
            document.getElementById('userPosition').value = user.position;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userPassword').value = '';
            
            document.getElementById('userModal').style.display = 'flex';
        }

        // حذف مستخدم
        function deleteUser(userId) {
            if (userId === 1) {
                alert('لا يمكن حذف الحساب الرئيسي');
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                appData.users = appData.users.filter(u => u.id !== userId);
                saveDataToStorage();
                renderUserList();
                alert('تم حذف المستخدم بنجاح');
            }
        }

        // عرض نموذج الصلاحيات
        function showPermissionsModal(userId) {
            const user = appData.users.find(u => u.id === userId);
            if (!user) return;
            
            const permissionsContent = document.getElementById('permissionsContent');
            permissionsContent.innerHTML = `
                <h4>صلاحيات ${user.name}</h4>
                <div class="permissions-section">
                    <h5>الصلاحيات الأساسية:</h5>
                    <div class="permissions-grid" id="basic-permissions-modal">
                        ${Object.keys(user.permissions).filter(p => !['departments'].includes(p)).map(permission => `
                            <div class="permission-item">
                                <span>${getPermissionName(permission)}</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" ${user.permissions[permission] ? 'checked' : ''} data-permission="${permission}">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <input type="hidden" id="permissionsUserId" value="${user.id}">
            `;
            
            document.getElementById('permissionsModal').style.display = 'flex';
        }

        // إغلاق نموذج الصلاحيات
        function closePermissionsModal() {
            document.getElementById('permissionsModal').style.display = 'none';
        }

        // حفظ الصلاحيات
        function savePermissions() {
            const userId = parseInt(document.getElementById('permissionsUserId').value);
            const user = appData.users.find(u => u.id === userId);
            if (!user) return;
            
            // تحديث الصلاحيات الأساسية
            document.querySelectorAll('#basic-permissions-modal input[type="checkbox"]').forEach(checkbox => {
                const permission = checkbox.getAttribute('data-permission');
                user.permissions[permission] = checkbox.checked;
            });
            
            saveDataToStorage();
            closePermissionsModal();
            alert('تم حفظ الصلاحيات بنجاح');
        }

        // عرض نموذج المعاينة
        function showPreviewModal(userId) {
            const user = appData.users.find(u => u.id === userId);
            if (!user) return;
            
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = `
                <div class="user-details">
                    <div class="user-avatar">${user.avatar}</div>
                    <div>
                        <h3>${user.name}</h3>
                        <p>الوظيفة: ${user.position}</p>
                        <p>اسم المستخدم: ${user.username}</p>
                        <p>الدور: ${getRoleName(user.role)}</p>
                        <p>الحالة: <span class="status-badge ${user.active ? 'status-active' : 'status-inactive'}">${user.active ? 'مفعل' : 'غير مفعل'}</span></p>
                    </div>
                </div>
                <div class="permissions-section">
                    <h4>الصلاحيات الممنوحة:</h4>
                    <div class="permissions-grid">
                        ${Object.keys(user.permissions).filter(p => !['departments'].includes(p) && user.permissions[p]).map(permission => `
                            <div class="permission-item">
                                <span>${getPermissionName(permission)}</span>
                                <i class="fas fa-check text-success"></i>
                            </div>
                        `).join('')}
                        ${Object.keys(user.permissions).filter(p => !['departments'].includes(p) && !user.permissions[p]).length > 0 ? `
                            <h5>الصلاحيات غير الممنوحة:</h5>
                            ${Object.keys(user.permissions).filter(p => !['departments'].includes(p) && !user.permissions[p]).map(permission => `
                                <div class="permission-item">
                                    <span>${getPermissionName(permission)}</span>
                                    <i class="fas fa-times text-danger"></i>
                                </div>
                            `).join('')}
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('previewModal').style.display = 'flex';
        }

        // إغلاق نموذج المعاينة
        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
        }

        // دوال الحفظ للبيانات المختلفة
        function saveMiddleLeadership() {
            saveDataToStorage();
            alert('تم حفظ بيانات القيادة الوسطى بنجاح');
        }

        function savePerformance() {
            saveDataToStorage();
            alert('تم حفظ بيانات التقييم بنجاح');
        }

        function saveTeachers() {
            saveDataToStorage();
            alert('تم حفظ بيانات المعلمين بنجاح');
        }

        function saveReports() {
            saveDataToStorage();
            alert('تم حفظ بيانات التقارير بنجاح');
        }

        // عرض البيانات
        function renderData() {
            renderDashboard();
            renderMiddleLeadership();
            renderVisits();
            renderPerformance();
            renderTeachers();
            renderReports();
        }

        // عرض لوحة التحكم
        function renderDashboard() {
            // حساب الإحصائيات
            const totalVisits = appData.visits.length;
            const distinguishedTeachers = appData.distinguishedTeachers.length;
            const teachersNeedCare = appData.teachersNeedCare.length;
            const performanceRate = Math.round((distinguishedTeachers / (distinguishedTeachers + teachersNeedCare)) * 100) || 0;
            
            // تحديث الإحصائيات
            document.getElementById('totalVisits').textContent = totalVisits;
            document.getElementById('distinguishedTeachers').textContent = distinguishedTeachers;
            document.getElementById('teachersNeedCare').textContent = teachersNeedCare;
            document.getElementById('performanceRate').textContent = `${performanceRate}%`;
            
            // عرض آخر الزيارات
            const recentVisitsTable = document.getElementById('recentVisitsTable');
            recentVisitsTable.innerHTML = '';
            
            appData.visits.slice(0, 5).forEach(visit => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${visit.teacher}</td>
                    <td>${visit.department}</td>
                    <td>${visit.date}</td>
                    <td>${visit.evaluation}</td>
                    <td>${visit.visitor}</td>
                `;
                recentVisitsTable.appendChild(row);
            });
        }

        // عرض بيانات القيادة الوسطى
        function renderMiddleLeadership() {
            const table = document.getElementById('middleLeadershipTable');
            table.innerHTML = '';
            
            // بيانات افتراضية للعرض
            const departments = ['اللغة العربية', 'الرياضيات', 'العلوم', 'اللغة الإنجليزية', 'التربية الإسلامية'];
            
            departments.forEach(dept => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dept}</td>
                    <td>${Math.floor(Math.random() * 10) + 1}</td>
                    <td>${Math.random() > 0.3 ? 'تم التسليم' : 'لم يتم التسليم'}</td>
                    <td>${Math.random() > 0.3 ? 'تم التسليم' : 'لم يتم التسليم'}</td>
                    <td>${Math.random() > 0.3 ? '-' : 'انشغال المعلم الأول'}</td>
                `;
                table.appendChild(row);
            });
        }

        // عرض بيانات الزيارات
        function renderVisits() {
            // عرض الزيارات للقسم النشط افتراضياً (القيادة العليا)
            renderVisitsByDepartment('القيادة العليا');
        }

        // عرض الزيارات حسب القسم
        function renderVisitsByDepartment(department) {
            const visitsContent = document.getElementById('visitsContent');
            visitsContent.innerHTML = '';
            
            if (department === 'القيادة العليا') {
                // عرض زيارات القيادة العليا حسب المستخدمين
                const seniorLeadershipUsers = appData.users.filter(u => u.role === 'senior_leadership');
                
                seniorLeadershipUsers.forEach(user => {
                    const userVisits = appData.visits.filter(visit => visit.visitor === user.name);
                    
                    if (userVisits.length > 0) {
                        const userSection = document.createElement('div');
                        userSection.className = 'department-section';
                        userSection.innerHTML = `
                            <h3 class="department-title">${user.name}</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>م</th>
                                        <th>اسم المعلم</th>
                                        <th>القسم</th>
                                        <th>تاريخ الزيارة</th>
                                        <th>تقييم الزيارة</th>
                                        <th>الملاحظات</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="visits-${user.id}">
                                </tbody>
                            </table>
                        `;
                        visitsContent.appendChild(userSection);
                        
                        const userVisitsTable = document.getElementById(`visits-${user.id}`);
                        userVisits.forEach((visit, index) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${visit.teacher}</td>
                                <td>${visit.department}</td>
                                <td>${visit.date}</td>
                                <td>${visit.evaluation}</td>
                                <td>${visit.notes}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning view-visit" data-id="${visit.id}">معاينة</button>
                                    <button class="btn btn-sm btn-secondary edit-visit" data-id="${visit.id}">تعديل</button>
                                    <button class="btn btn-sm btn-danger delete-visit" data-id="${visit.id}">حذف</button>
                                </td>
                            `;
                            userVisitsTable.appendChild(row);
                        });
                    }
                });
                
            } else if (department === 'القيادة الوسطى') {
                // عرض زيارات القيادة الوسطى حسب المستخدمين
                const middleLeadershipUsers = appData.users.filter(u => u.role === 'middle_leadership');
                
                middleLeadershipUsers.forEach(user => {
                    const userVisits = appData.visits.filter(visit => visit.visitor === user.name);
                    
                    if (userVisits.length > 0) {
                        const userSection = document.createElement('div');
                        userSection.className = 'department-section';
                        userSection.innerHTML = `
                            <h3 class="department-title">${user.name}</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>م</th>
                                        <th>اسم المعلم</th>
                                        <th>القسم</th>
                                        <th>تاريخ الزيارة</th>
                                        <th>تقييم الزيارة</th>
                                        <th>الملاحظات</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="visits-${user.id}">
                                </tbody>
                            </table>
                        `;
                        visitsContent.appendChild(userSection);
                        
                        const userVisitsTable = document.getElementById(`visits-${user.id}`);
                        userVisits.forEach((visit, index) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${visit.teacher}</td>
                                <td>${visit.department}</td>
                                <td>${visit.date}</td>
                                <td>${visit.evaluation}</td>
                                <td>${visit.notes}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning view-visit" data-id="${visit.id}">معاينة</button>
                                    <button class="btn btn-sm btn-secondary edit-visit" data-id="${visit.id}">تعديل</button>
                                    <button class="btn btn-sm btn-danger delete-visit" data-id="${visit.id}">حذف</button>
                                </td>
                            `;
                            userVisitsTable.appendChild(row);
                        });
                    }
                });
            }
            
            // إضافة معالجي الأحداث للأزرار
            document.querySelectorAll('.view-visit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const visitId = parseInt(this.getAttribute('data-id'));
                    viewVisit(visitId);
                });
            });
            
            document.querySelectorAll('.edit-visit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const visitId = parseInt(this.getAttribute('data-id'));
                    editVisit(visitId);
                });
            });
            
            document.querySelectorAll('.delete-visit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const visitId = parseInt(this.getAttribute('data-id'));
                    deleteVisit(visitId);
                });
            });
        }

        // عرض بيانات التقييم
        function renderPerformance() {
            const table = document.getElementById('performanceTable');
            table.innerHTML = '';
            
            // بيانات افتراضية للعرض
            const departments = ['اللغة العربية', 'الرياضيات', 'العلوم', 'اللغة الإنجليزية', 'التربية الإسلامية'];
            
            departments.forEach((dept, index) => {
                const total = Math.floor(Math.random() * 20) + 10;
                const excellent = Math.floor(Math.random() * 5) + 1;
                const veryGood = Math.floor(Math.random() * 5) + 1;
                const good = Math.floor(Math.random() * 5) + 1;
                const fair = total - (excellent + veryGood + good);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${dept}</td>
                    <td>${total}</td>
                    <td>${excellent}</td>
                    <td>${veryGood}</td>
                    <td>${good}</td>
                    <td>${fair}</td>
                `;
                table.appendChild(row);
            });
            
            // عرض الرسم البياني
            renderPerformanceChart();
        }

        // عرض الرسم البياني لتقييم الأداء
        function renderPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // إذا كان هناك رسم بياني موجود، قم بتدميره أولاً
            if (window.performanceChartInstance) {
                window.performanceChartInstance.destroy();
            }
            
            const departments = ['اللغة العربية', 'الرياضيات', 'العلوم', 'اللغة الإنجليزية', 'التربية الإسلامية'];
            const excellentData = departments.map(() => Math.floor(Math.random() * 5) + 1);
            const veryGoodData = departments.map(() => Math.floor(Math.random() * 5) + 1);
            const goodData = departments.map(() => Math.floor(Math.random() * 5) + 1);
            const fairData = departments.map(() => Math.floor(Math.random() * 5) + 1);
            
            // ألوان أكثر جمالية
            const colors = {
                excellent: 'rgba(40, 167, 69, 0.8)',
                veryGood: 'rgba(23, 162, 184, 0.8)',
                good: 'rgba(255, 193, 7, 0.8)',
                fair: 'rgba(220, 53, 69, 0.8)'
            };
            
            window.performanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: departments,
                    datasets: [
                        {
                            label: 'يفوق التوقعات بكثير',
                            data: excellentData,
                            backgroundColor: colors.excellent,
                            borderColor: colors.excellent.replace('0.8', '1'),
                            borderWidth: 2,
                            borderRadius: 5,
                            borderSkipped: false,
                        },
                        {
                            label: 'يفوق التوقعات',
                            data: veryGoodData,
                            backgroundColor: colors.veryGood,
                            borderColor: colors.veryGood.replace('0.8', '1'),
                            borderWidth: 2,
                            borderRadius: 5,
                            borderSkipped: false,
                        },
                        {
                            label: 'يفي بالتوقعات',
                            data: goodData,
                            backgroundColor: colors.good,
                            borderColor: colors.good.replace('0.8', '1'),
                            borderWidth: 2,
                            borderRadius: 5,
                            borderSkipped: false,
                        },
                        {
                            label: 'يفي بالتوقعات جزئياً',
                            data: fairData,
                            backgroundColor: colors.fair,
                            borderColor: colors.fair.replace('0.8', '1'),
                            borderWidth: 2,
                            borderRadius: 5,
                            borderSkipped: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true,
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 14,
                                    family: 'Cairo'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'توزيع تقييمات الأداء الصفي حسب الأقسام',
                            font: {
                                size: 18,
                                family: 'Cairo',
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleFont: {
                                family: 'Cairo'
                            },
                            bodyFont: {
                                family: 'Cairo'
                            },
                            padding: 10,
                            cornerRadius: 5
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'الأقسام الأكاديمية',
                                font: {
                                    size: 14,
                                    family: 'Cairo',
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'عدد الزيارات',
                                font: {
                                    size: 14,
                                    family: 'Cairo',
                                    weight: 'bold'
                                }
                            },
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                },
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // عرض بيانات المعلمين
        function renderTeachers() {
            // المعلمين المتميزين
            const distinguishedTable = document.getElementById('distinguishedTeachersTable');
            distinguishedTable.innerHTML = '';
            
            // بيانات افتراضية للعرض
            const distinguishedTeachers = [
                { name: 'أحمد محمد', evaluation: 'ممتاز', reasons: 'تفوق في استخدام استراتيجيات التعلم النشط', department: 'اللغة العربية' },
                { name: 'فاطمة علي', evaluation: 'جيد جداً', reasons: 'تميز في إدارة الصف وتنظيم الوقت', department: 'الرياضيات' },
                { name: 'سارة خالد', evaluation: 'ممتاز', reasons: 'إبداع في تصميم الأنشطة الصفية', department: 'العلوم' }
            ];
            
            distinguishedTeachers.forEach((teacher, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${teacher.name}</td>
                    <td>${teacher.evaluation}</td>
                    <td>${teacher.reasons}</td>
                    <td>${teacher.department}</td>
                `;
                distinguishedTable.appendChild(row);
            });
            
            // المعلمين الأولى بالرعاية
            const needCareTable = document.getElementById('teachersNeedCareTable');
            needCareTable.innerHTML = '';
            
            // بيانات افتراضية للعرض
            const teachersNeedCare = [
                { name: 'محمد أحمد', evaluation: 'مقبول', reasons: 'صعوبة في إدارة الصف', department: 'اللغة الإنجليزية' },
                { name: 'نورة سعيد', evaluation: 'ضعيف', reasons: 'ضعف في استخدام الوسائل التعليمية', department: 'التربية الإسلامية' }
            ];
            
            teachersNeedCare.forEach((teacher, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${teacher.name}</td>
                    <td>${teacher.evaluation}</td>
                    <td>${teacher.reasons}</td>
                    <td>${teacher.department}</td>
                `;
                needCareTable.appendChild(row);
            });
        }

        // عرض بيانات التقارير
        function renderReports() {
            const table = document.getElementById('reportsTable');
            table.innerHTML = '';
            
            // بيانات افتراضية للعرض
            const departments = ['اللغة العربية', 'الرياضيات', 'العلوم', 'اللغة الإنجليزية', 'التربية الإسلامية'];
            
            departments.forEach(dept => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dept}</td>
                    <td>تفعيل استراتيجيات التعلم النشط، استخدام الوسائل التعليمية المتنوعة</td>
                    <td>تحسين مهارات إدارة الوقت، تطوير أساليب التقويم</td>
                `;
                table.appendChild(row);
            });
        }
    </script>
</body>
</html>
